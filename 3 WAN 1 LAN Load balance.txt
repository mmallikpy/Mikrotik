# 3 WAN load balance
# ***** After configure using this script you shouled check using 3 host or 3 download session

/interface ethernet
set [ find default-name=ether2 ] name=ether1-ISP_2
set [ find default-name=ether3 ] name=ether2-LAN
set [ find default-name=ether4 ] name=ether3-ISP_3
set [ find default-name=ether1 ] name=ether4-ISP_1

/ip address
add address=172.16.1.2/30 interface=ether4-ISP_1 network=172.16.1.0
add address=172.16.2.2/30 interface=ether1-ISP_2 network=172.16.2.0
add address=192.168.111.1/24 interface=ether2-LAN network=192.168.111.0
add address=172.16.3.2/30 interface=ether3-ISP_3 network=172.16.3.0

/ip firewall mangle
add action=mark-connection chain=prerouting connection-state=new in-interface=ether2-LAN new-connection-mark=conn1 nth=3,1 passthrough=yes
add action=mark-routing chain=prerouting connection-mark=conn1 in-interface=ether2-LAN new-routing-mark=conn1 passthrough=no

add action=mark-connection chain=prerouting connection-state=new in-interface=ether2-LAN new-connection-mark=conn2 nth=2,1 passthrough=yes
add action=mark-routing chain=prerouting connection-mark=conn2 in-interface=ether2-LAN new-routing-mark=conn2 passthrough=no

add action=mark-connection chain=prerouting connection-state=new in-interface=ether2-LAN new-connection-mark=conn3 nth=1,1 passthrough=yes
add action=mark-routing chain=prerouting connection-mark=conn3 in-interface=ether2-LAN new-routing-mark=conn3 passthrough=no


/ip firewall nat
add action=masquerade chain=srcnat connection-mark=conn1 out-interface=ether4-ISP_1
add action=masquerade chain=srcnat connection-mark=conn2 out-interface=ether1-ISP_2
add action=masquerade chain=srcnat connection-mark=conn3 out-interface=ether3-ISP_3


/ip route
add check-gateway=ping comment=ISP1 distance=1 gateway=172.16.1.1 routing-mark=conn1
add check-gateway=ping comment=ISP2 distance=1 gateway=172.16.2.1 routing-mark=conn2
add check-gateway=ping comment=ISP3 distance=1 gateway=172.16.3.1 routing-mark=conn3

add check-gateway=ping comment=ISP1 distance=10 gateway=172.16.1.1
add check-gateway=ping comment=ISP2 distance=15 gateway=172.16.2.1
add check-gateway=ping comment=ISP3 distance=16 gateway=172.16.3.1